@page "/ShoppingList"


@using HomeAppsBlazerServer.Components.Pages.Shopping.PriceHistory
@using HomeAppsBlazerServer.Models
@using HomeAppsBlazerServer.Models.Shopping
@using HomeAppsBlazerServer.Servcies
@using HomeAppsBlazerServer.Servcies.Shopping

@*Endalbes it*@
@* @rendermode InteractiveServer *@

@* jackes up the view of the table *@
@rendermode @(new InteractiveServerRenderMode(prerender: false))


@* Loads as it as it download it. *@
@attribute [StreamRendering]

@inject IShoppingServices ShoppingServices

@inject NavigationManager NavigationManger
@inject IJSRuntime JsRuntime

@layout HomeAppsBlazerServer.Components.Layout.Shopping.ShoppingLayout

<PageTitle>Shopping List</PageTitle>
<h3>Shopping Items</h3>


<!-- Main Navigation -->
<div class="shopping-nav card mb-4">
    <div class="card-body p-3">
        <nav class="nav nav-pills">
            <NavLink class="nav-link" href="ShoppingItems" Match="NavLinkMatch.All">
                <i class="bi bi-grid me-1"></i> All Items
            </NavLink>
            <NavLink class="nav-link" href="CreateEditListItem">
                <i class="bi bi-plus-circle me-1"></i> Add Item to List
            </NavLink>
            <NavLink class="nav-link" href="edit-item">
                <i class="bi bi-file-earmark-plus me-1"></i> Add New Item
            </NavLink>
        </nav>
    </div>
</div>

<!-- Shopping List Content -->

<div class="shopping-list-container">
    @if (CurrentShoppingList is null)
    {
        <div class="alert alert-info">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span>Loading list items...</span>
            </div>
        </div>
    }
    else if (CurrentShoppingList.Count.Equals(0))
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No items found in the list.
        </div>
    }
    else
    {
        <ShoppingListNeedDate Items="@CurrentShoppingList.Where(mm => (mm.NeedDate >= DateTime.Now.AddDays(-5) && mm.NeedDate<= DateTime.Now.AddDays(5)) || mm.NeedDate is null)"
                FilterDate="@DateTime.Now.AddDays(-5)"
                OnItemClick="@GotItem"
                OnShowHistory="@ShowHistory"
                OnEditItem="@EditItem" />

                <br />
                <hr >
                <br />

        <ShoppingListNeedDate
                Items="@CurrentShoppingList.Where(mm => mm.NeedDate >= DateTime.Now.AddDays(5))"
                FilterDate="@DateTime.Now.AddDays(5)"
                OnItemClick="@GotItem"
                OnShowHistory="@ShowHistory"
                OnEditItem="@EditItem" />

    }
</div>

<PriceHistoryOverview @ref="popupRef" />

<!-- Add these styles to your component or stylesheet -->
<style>


    .shopping-nav .nav-link {
        color: #4a5568;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
    }

        .shopping-nav .nav-link:hover {
            background-color: #e2e8f0;
        }

        .shopping-nav .nav-link.active {
            background-color: #3182ce;
            color: white;
        }

    .shopping-list-container {
        max-width: 1100px;
        margin: 0 auto;
    }

    .item-details {
        font-size: 0.9rem;
    }

    @@media (max-width: 768px) {
        .item-details {
            margin-top: 0.25rem;
        }
    }
</style>

<!-- Add Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">


@code {
    List<ShoppingItemResult> CurrentShoppingList;

    private PriceHistoryOverview popupRef;
    private string ItemName = string.Empty;

    private decimal TotalPrice { get; set; } = 0;

  
    private void ShowHistory(int id)
    {

        List<PriceHistory> ItemPriceHistory =  ShoppingServices.GetPriceHisotry(id).Result;

        ItemName = CurrentShoppingList.FirstOrDefault(mm => mm.ItemID == id)?.ItemName;

        popupRef.Show(ItemPriceHistory, ItemName);
    }


    protected override async Task OnInitializedAsync()
    {
        CurrentShoppingList = await GetShoppingItems();

       
        // TotalPrice = CurrentShoppingList
        //             .Where(m => m.Price.HasValue)
        //             .Sum(m => m.Price.Value * (m.NumberOfItems ?? 1));
       
    }


    async Task<List<ShoppingItemResult>> GetShoppingItems()
    {
        return await ShoppingServices.GetAllNeedItemsAsync();
    }

    void EditItem(int id)
    {
        NavigationManger.NavigateTo($"CreateEditListItem/{id}");
    }

    async Task GotItem(ShoppingItemResult itemgot)
    {
        bool success = await ShoppingServices.GotItem(itemgot.ShoppingItemListID);

        if (success)
            CurrentShoppingList.Remove(itemgot);
        
            //await JsRuntime.InvokeVoidAsync("alert", "Item Added");

    }


}
